<div class="survey-view-container">
  
  <div *ngIf="loading" class="text-center py-5">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
    <p class="mt-3 text-muted">Ładowanie ankiety...</p>
  </div>

  <div *ngIf="!loading && survey">
    
    <div class="preview-banner sticky-top">
      <div class="container">
        <div class="preview-banner-content">
          <div class="preview-info">
            <div class="preview-badge">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                <circle cx="12" cy="12" r="3"/>
              </svg>
              <span>Tryb podglądu</span>
            </div>
            <p class="preview-description mb-0">To wersja demonstracyjna ankiety. Możesz sprawdzić wygląd, ale odpowiedzi nie będą zapisane.</p>
          </div>
          <div class="preview-actions">
            <button class="btn btn-sm btn-outline-primary" (click)="goToEdit()">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-1">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
              </svg>
              Edytuj
            </button>
            <button class="btn btn-sm btn-outline-secondary" (click)="setActiveTab('share')" *ngIf="activeTab === 'preview'">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-1">
                <circle cx="18" cy="5" r="3"/>
                <circle cx="6" cy="12" r="3"/>
                <circle cx="18" cy="19" r="3"/>
                <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
                <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
              </svg>
              Udostępnij
            </button>
            <a routerLink="/surveys" class="btn btn-sm btn-secondary">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-1">
                <line x1="19" y1="12" x2="5" y2="12"/>
                <polyline points="12 19 5 12 12 5"/>
              </svg>
              Powrót
            </a>
          </div>
        </div>
      </div>
    </div>

    <div class="preview-tabs">
      <div class="container">
        <div class="tabs-wrapper">
          <button 
            class="tab-button" 
            [class.active]="activeTab === 'preview'"
            (click)="setActiveTab('preview')">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-1">
              <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
              <circle cx="12" cy="12" r="3"/>
            </svg>
            Podgląd ankiety
          </button>
          <button 
            class="tab-button" 
            [class.active]="activeTab === 'share'"
            (click)="setActiveTab('share')">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-1">
              <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
              <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
            </svg>
            Udostępnianie
          </button>
        </div>
      </div>
    </div>

    <div *ngIf="activeTab === 'preview'" class="preview-content">
      <div class="container">
        
        <div class="viewport-selector mb-4">
          <button 
            class="viewport-btn" 
            [class.active]="viewportMode === 'desktop'"
            (click)="setViewportMode('desktop')">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
              <line x1="8" y1="21" x2="16" y2="21"/>
              <line x1="12" y1="17" x2="12" y2="21"/>
            </svg>
            Desktop
          </button>
          <button 
            class="viewport-btn" 
            [class.active]="viewportMode === 'mobile'"
            (click)="setViewportMode('mobile')">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="5" y="2" width="14" height="20" rx="2" ry="2"/>
              <line x1="12" y1="18" x2="12.01" y2="18"/>
            </svg>
            Mobile
          </button>
        </div>

        <div class="survey-viewport" [class.mobile-mode]="viewportMode === 'mobile'">
          <div class="survey-preview-card">
            
            <div class="survey-header">
              <h1 class="survey-title">{{ survey.name }}</h1>
              <div class="survey-meta d-flex flex-wrap gap-3 align-items-center">
                <span class="d-flex align-items-center gap-1">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12 6 12 12 16 14"/>
                  </svg>
                  <strong>~{{ getEstimatedTime() }} min</strong>
                </span>
                <span>-</span>
                <span>{{ survey.questions.length }} {{ survey.questions.length === 1 ? 'pytanie' : 'pytań' }}</span>
                <span>-</span>
                <span class="badge" [ngClass]="{
                  'bg-success': survey.status === 'public',
                  'bg-warning': survey.status === 'private',
                  'bg-secondary': survey.status === 'expired'
                }">
                  {{ survey.status === 'public' ? 'Publiczna' : survey.status === 'private' ? 'Prywatna' : 'Wygasła' }}
                </span>
              </div>

              <div class="anonymous-badge-enhanced">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                  <path d="M9 12l2 2 4-4"/>
                </svg>
                <span>Ankieta jest całkowicie anonimowa</span>
              </div>
            </div>

            <div class="questions-container">
              <div *ngFor="let question of survey.questions; let i = index" class="question-wrapper">
                <div class="question-card">
                  <div class="question-header-row">
                    <span class="question-number">{{ i + 1 }}</span>
                    <span class="question-type-badge">{{ getAnswerTypeLabel(question.answer_type) }}</span>
                  </div>

                  <h3 class="question-content">{{ question.content }}</h3>

                  <div *ngIf="question.answer_type === 'open'" class="answer-section">
                    <textarea 
                      class="form-control" 
                      rows="4" 
                      placeholder="Wpisz swoją odpowiedź..."
                      disabled></textarea>
                  </div>

                  <div *ngIf="question.answer_type === 'close'" class="answer-section">
                    <div *ngFor="let choice of question.choices; let j = index" class="form-check">
                      <input 
                        class="form-check-input" 
                        type="radio" 
                        [name]="'question-' + i"
                        [id]="'q' + i + 'c' + j"
                        disabled>
                      <label class="form-check-label" [for]="'q' + i + 'c' + j">
                        {{ choice.content }}
                      </label>
                    </div>
                  </div>

                  <div *ngIf="question.answer_type === 'multiple'" class="answer-section">
                    <div *ngFor="let choice of question.choices; let j = index" class="form-check">
                      <input 
                        class="form-check-input" 
                        type="checkbox" 
                        [id]="'q' + i + 'c' + j"
                        disabled>
                      <label class="form-check-label" [for]="'q' + i + 'c' + j">
                        {{ choice.content }}
                      </label>
                    </div>
                  </div>

                  <div *ngIf="question.answer_type === 'scale'" class="answer-section">
                    <input 
                      type="range" 
                      class="form-range" 
                      min="1" 
                      max="5" 
                      disabled>
                    <div class="d-flex justify-content-between text-muted small">
                      <span>1</span>
                      <span>2</span>
                      <span>3</span>
                      <span>4</span>
                      <span>5</span>
                    </div>
                  </div>

                  <div *ngIf="question.answer_type === 'rating'" class="answer-section">
                    <div class="rating-stars">
                      <svg *ngFor="let star of [1,2,3,4,5]" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                      </svg>
                    </div>
                  </div>

                  <div *ngIf="question.answer_type === 'yes_no'" class="answer-section">
                    <div class="btn-group w-100" role="group">
                      <button type="button" class="btn btn-outline-success" disabled>Tak</button>
                      <button type="button" class="btn btn-outline-danger" disabled>Nie</button>
                    </div>
                  </div>

                  <div *ngIf="question.answer_type === 'dropdown'" class="answer-section">
                    <select class="form-select" disabled>
                      <option selected>Wybierz opcję...</option>
                      <option *ngFor="let choice of question.choices">{{ choice.content }}</option>
                    </select>
                  </div>

                  <div *ngIf="question.answer_type === 'date'" class="answer-section">
                    <input type="date" class="form-control" disabled>
                  </div>

                  <div *ngIf="question.answer_type === 'email'" class="answer-section">
                    <input type="email" class="form-control" placeholder="twoj@email.com" disabled>
                  </div>

                  <div *ngIf="question.answer_type === 'number'" class="answer-section">
                    <input type="number" class="form-control" placeholder="Wpisz liczbę..." disabled>
                  </div>
                </div>
              </div>
            </div>

            <div class="submit-section">
              <button class="btn btn-primary btn-lg w-100" disabled>
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2">
                  <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                  <polyline points="22 4 12 14.01 9 11.01"/>
                </svg>
                Wyślij ankietę
              </button>
              <p class="text-center text-muted small mt-3 mb-0">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-1">
                  <circle cx="12" cy="12" r="10"/>
                  <line x1="12" y1="16" x2="12" y2="12"/>
                  <line x1="12" y1="8" x2="12.01" y2="8"/>
                </svg>
                Tryb podglądu - odpowiedzi nie będą zapisane
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="activeTab === 'share'" class="share-content">
      <div class="container">
        <div class="row justify-content-center">
          <div class="col-lg-8">
            <div class="card">
              <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                  <h5 class="mb-0">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-2">
                      <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                      <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                    </svg>
                    Linki udostępniania
                  </h5>
                  <button 
                    class="btn btn-sm btn-primary"
                    (click)="createShareLink()"
                    [disabled]="creatingShareLink">
                    <span *ngIf="!creatingShareLink">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-1">
                        <line x1="12" y1="5" x2="12" y2="19"/>
                        <line x1="5" y1="12" x2="19" y2="12"/>
                      </svg>
                      Utwórz nowy link
                    </span>
                    <span *ngIf="creatingShareLink">
                      <span class="spinner-border spinner-border-sm me-1"></span>
                      Tworzenie...
                    </span>
                  </button>
                </div>
              </div>
              <div class="card-body">
                <div *ngIf="loadingShareLinks" class="text-center py-3">
                  <div class="spinner-border spinner-border-sm text-primary"></div>
                </div>

                <div *ngIf="!loadingShareLinks && shareLinks.length === 0" class="text-center text-muted py-5">
                  <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="mb-3">
                    <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
                    <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
                  </svg>
                  <p>Brak linków udostępniania. Utwórz pierwszy link, aby udostępnić ankietę.</p>
                </div>

                <div *ngIf="!loadingShareLinks && shareLinks.length > 0">
                  <div *ngFor="let link of shareLinks" class="share-link-item">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                      <div class="flex-grow-1">
                        <div class="input-group mb-2">
                          <input 
                            type="text" 
                            class="form-control"
                            [value]="getShareUrl(link.share_token)"
                            readonly>
                          <button 
                            class="btn btn-outline-primary"
                            (click)="copyShareLink(link.share_token)"
                            title="Kopiuj link">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                            </svg>
                          </button>
                        </div>
                        <small class="text-muted">
                          Utworzono: {{ link.created_at | date: 'dd.MM.yyyy, HH:mm' }} | 
                          Kliknięcia: {{ link.clicks }}
                        </small>
                      </div>
                    </div>
                    <div class="d-flex gap-2">
                      <button 
                        class="btn btn-sm btn-outline-success"
                        (click)="generateQRCode(link.share_token)">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-1">
                          <rect x="3" y="3" width="7" height="7"/>
                          <rect x="14" y="3" width="7" height="7"/>
                          <rect x="14" y="14" width="7" height="7"/>
                          <rect x="3" y="14" width="7" height="7"/>
                        </svg>
                        Pokaż QR Code
                      </button>
                      <button 
                        class="btn btn-sm btn-outline-danger"
                        (click)="deleteShareLink(link.id)">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="me-1">
                          <polyline points="3 6 5 6 21 6"/>
                          <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                        </svg>
                        Usuń
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div 
  class="modal" 
  [class.show]="showShareModal" 
  [style.display]="showShareModal ? 'block' : 'none'" 
  tabindex="-1"
  (keydown)="handleKeyDown($event)">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Kod QR do ankiety</h5>
        <button 
          type="button" 
          class="btn-close" 
          (click)="closeShareModal()"
          aria-label="Zamknij modal"></button>
      </div>
      <div class="modal-body text-center">
        <img 
          *ngIf="qrCodeDataUrl" 
          [src]="qrCodeDataUrl" 
          alt="Kod QR prowadzący do ankiety"
          class="img-fluid mb-3">
        <p class="text-muted">Zeskanuj kod QR, aby otworzyć ankietę na urządzeniu mobilnym</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeShareModal()">Zamknij</button>
        <button type="button" class="btn btn-primary" (click)="downloadQRCode()">
          Pobierz QR Code
        </button>
      </div>
    </div>
  </div>
</div>
<div class="modal-backdrop" [class.show]="showShareModal" [style.display]="showShareModal ? 'block' : 'none'" (click)="closeShareModal()"></div>
